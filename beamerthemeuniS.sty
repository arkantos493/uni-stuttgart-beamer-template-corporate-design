% Copyright 2017 by Christian Senger <senger@inue.uni-stuttgart.de>
%
% This file may be distributed and/or modified
%
% 1. under the LaTeX Project Public License and/or
% 2. under the GNU Public License.
%
% See the file doc/licenses/LICENSE for more details.

% reset footnote counter per page, adapt footnotes
\usepackage{perpage}
\MakePerPage{footnote}
\renewcommand*{\thefootnote}{\fnsymbol{footnote}}
\renewcommand\footnoterule{}

% set up fonts
\usepackage{lmodern}
\usepackage{csquotes}

\usepackage{iftex}
\ifLuaTeX

\usepackage{fontspec}
\setsansfont[
BoldFont = UniversforUniS65Bd-Regular,
ItalicFont = UniversforUniS45LtObl-Rg,
BoldItalicFont = UniversforUniS45LtObl-Rg,
Scale = MatchUppercase 
]{UniversforUniS55Rm-Regular}

\renewcommand{\familydefault}{\sfdefault}

\else

\usepackage[T1]{fontenc}
\usepackage{inputenc}

\fi


% fix some latex quirks
\usepackage{xspace}
\usepackage[xspace]{ellipsis}
\usepackage{fixmath}
\usepackage[stretch=10]{microtype}


% use fancy enumerate/itemize and restore beamer layout
\usepackage{enumitem}\setitemize{%
  label=\usebeamerfont*{itemize item}
  \usebeamercolor[fg]{itemize item}
  \usebeamertemplate{itemize item}
}

% necessary packages
\usepackage{appendixnumberbeamer}
\usepackage{biblatex}
\usepackage{etoolbox}
\usepackage{phonenumbers}
\usepackage{tikz}
\usepackage{xargs}
\usepackage{xifthen}

\makeatletter
\def\beamerrightmargin{\dimexpr\Gm@rmargin\relax}
\makeatother

\makeatletter
\newcommand\changemode[1]{%
	\gdef\beamer@currentmode{#1}}
\makeatother


\mode<presentation>

\useoutertheme{uniS}
\useinnertheme{rectangles}

\usecolortheme{uniS}

\usefonttheme[onlymath]{serif}
\setbeamerfont{block title}{size=\small}

\setbeamersize{text margin left=1cm}
\setbeamersize{text margin right=1cm}

\setbeamertemplate{navigation symbols}{}


% define a few pictures used throughout the slides
\iflanguage{ngerman}{
	\def\university{Universität Stuttgart}
	\pgfdeclareimage[height=1cm]{unilogo}{.logos/unilogo.pdf}    % UniS logo for title slide
	\pgfdeclareimage[height=1cm]{unilogow}{.logos/unilogo_w.pdf} % (white) UniS logo for final slide
}{
	\pgfdeclareimage[height=1cm]{unilogo}{.logos/unilogo_en.pdf}    % UniS logo for title slide
	\pgfdeclareimage[height=1cm]{unilogow}{.logos/unilogo_w_en.pdf} % (white) UniS logo for final slide
	\def\university{University of Stuttgart}
}


% automatically display \sectionpage at beginning of every \section{}
\AtBeginSection[]{%
	\begin{frame}[plain]
		\sectionpage
	\end{frame}
	% uncomment block in order to display toc after every sectionpage
	%\begin{frame}[c, plain]
	%  \tableofcontents[currentsection]
	%\end{frame}
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% finalslide %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\newcommand{\email}[2][]{
	\gdef\@email{#2}
	\ifthenelse{\equal{#1}{useicon}}{\gdef\@useiconemail{}}{}
}
\newcommand{\phone}[2][]{
	\gdef\@phone{#2}
	\ifthenelse{\equal{#1}{useicon}}{\gdef\@useiconphone{}}{}
}
\renewcommand{\fax}[2][]{
	\gdef\@fax{#2}
	\ifthenelse{\equal{#1}{useicon}}{\gdef\@useiconfax{}}{}
}
\newcommand{\speakerimage}[1]{\gdef\@speakerimage{#1}}

\newcommand{\finalslide}{
  \begin{frame}[plain]
    \begin{tikzpicture}[overlay, remember picture]
      \clip (current page.north west) rectangle (current page.south east);
      % uncomment in order to repeat title page background, also uncomment opacity below
      %\node[anchor=north west] at ([xshift=-1em, yshift=1ex]current page.north west) {\includegraphics[width=\textwidth+1em+2\beamerrightmargin]{\backgroundimage}};
      
      % Background
      \shade[%
        top color=uniSlightblue,
        bottom color=uniSblue,
        shading angle=-45,
        %opacity=.8
        ]
        (current page.north west) rectangle (current page.south east);
        \node[anchor=north west] at ([xshift=1cm, yshift=-1cm]current page.north west) {\pgfuseimage{unilogow}};
    \end{tikzpicture}

    \vspace{3.25cm}

    \begin{columns}[c]
      \begin{column}{2.5cm}
		\ifdef{\@speakerimage}{
			\begin{tikzpicture}
			\node[circle,minimum size=2.5cm, path picture={
				\node at (path picture bounding box.center){\includegraphics[width=2.5cm]{\@speakerimage}};}] {};
			\end{tikzpicture}
		}{}
        
      \end{column}
      \begin{column}{.7\textwidth}
    	\ifdef{\@useiconemail}{
    		\def\emailicon{\Letter}
    	}{
    		\iflanguage{ngerman}{
    			\def\emailicon{Email}
    		}{
    			\def\emailicon{email}
    		}
    	}
    	\ifdef{\@useiconphone}{
    		\def\phoneicon{\Telefon}
    	}{
    		\iflanguage{ngerman}{
    			\def\phoneicon{Telefon}
    		}{
    			\def\phoneicon{phone}
    		}
    	}
    	\ifdef{\@useiconfax}{
    		\def\faxicon{\FAX}
    	}{
    		\iflanguage{ngerman}{
    			\def\faxicon{Fax}
    		}{
    			\def\faxicon{fax}
    		}
    	}
        
        \begin{beamercolorbox}
          {palette tertiary}
          \begin{tabular}{rl}
            \multicolumn{2}{l}{\insertshortauthor} \\
            \multicolumn{2}{l}{\university, \insertinstitute} \\
            \rule{0pt}{4ex}\\
            
            \ifdef{\@email}{
              \emailicon & \href{mailto:\@email}{\@email} \\
            }{
        	  \PackageError{finalslide}{No email specified!}{}
    		}
            \ifdef{\@phone}{
              \phoneicon & \phonenumber{\@phone} \\
       	    }{}
            \ifdef{\@fax}{
              \faxicon & \@fax \\
            }{}
          \end{tabular}
        \end{beamercolorbox}
      \end{column}
    \end{columns}
	\vfill
  \end{frame}
}

\makeatother

\newcommand{\appendixslide}[1]{
	\appendix
	\input{#1}
}

\makeatletter
\newcommand{\bibresource}[1]{\gdef\@bibresource{#1}}
\ifdef{\@bibresource}{\addbibresource{\@bibresource}}{}

\newcommand{\bibliographyslide}[1][]{
	\ifdef{\@bibresource}{
		\ifthenelse{\isempty{#1}}{
			\iflanguage{ngerman}{
				\def\bibtitle{Quellen}
			}{
				\def\bibtitle{References}
			}
		}{
			\def\bibtitle{#1}
		}
		\begin{frame}{\bibtitle}
			\renewcommand*{\bibfont}{\tiny}
			\printbibliography
		\end{frame}
	}{
		\PackageError{Bibliography Frame}{Can't create bibliography frame since no bib resources are given!}{Please set bibresources to the path of your bibliography file.}
	}
}
\makeatother

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% title page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\newcommand{\backgroundimage}[1]{\gdef\@backgroundimage{#1}}

\newlength{\circlesize}
\setbeamertemplate{title page}%
{
  \addtocounter{framenumber}{-1}
  \setlength{\circlesize}{1.12\textheight}
  \begin{tikzpicture}[overlay, remember picture]
    \clip (current page.north west) rectangle (current page.south east);
    
    \ifdef{\@backgroundimage}{
	    % background image
	    \node[anchor=north west] at ([xshift=-1em, yshift=1ex]current page.north west){\includegraphics[width=\textwidth+1em+2\beamerrightmargin]{\@backgroundimage}};
	    
	    % Uni logo
	    \node[%
	    rectangle,
	    draw=white,
	    fill=white,
	    anchor=north west,
	    minimum width=2\textwidth,
	    minimum height=3cm]
	    at (current page.north west) {};
	    \node[anchor=north west] at ([xshift=1cm, yshift=-1cm]current page.north west) {\pgfuseimage{unilogo}};
	}{
		\shade[%
		top color=uniSlightblue,
		bottom color=uniSblue,
		shading angle=-45,
		%opacity=.8
		]
		(current page.north west) rectangle (current page.south east);
		\node[anchor=north west] at ([xshift=1cm, yshift=-1cm]current page.north west) {\pgfuseimage{unilogow}};
	}
    
    % Title
    \node[%
      circle,
      fill=uniSgray,
      text=white,
      anchor=south east,
      minimum size=\circlesize,
      align=left,
      font=\bfseries\Huge]
      (title) at ([yshift=-.05\circlesize]current page.south east) {\inserttitle};
    \setlength{\circlesize}{.2\textheight}
    
    % Author
    \node[%
      circle,
      fill=white,
      anchor=center,
      minimum size=\circlesize,
      align=left,
      font=\bfseries\normalsize]
      at ([xshift=-.1\circlesize, yshift=-.6\circlesize]title.north west) {\insertauthor};
  \end{tikzpicture}
}
\makeatother

\newcommand{\titleslide}{
\begin{frame}[plain]
	\titlepage
\end{frame}
}

\newcommand{\tocslide}[1][]{
	\ifthenelse{\isempty{#1}}{
		\iflanguage{ngerman}{
			\def\toctitle{Übersicht}
		}{
			\def\toctitle{Overview}
		}
	}{
		\def\toctitle{#1}
	}
	
	\begin{frame}{\toctitle}
		\tableofcontents
	\end{frame}
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% section page %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setbeamertemplate{section page}%
{
  \addtocounter{framenumber}{-1}
  \begin{tikzpicture}[overlay, remember picture]
    \setlength{\circlesize}{.9\textheight}
    \clip (current page.north west) rectangle (current page.south east);
    \shade[%
      top color=uniSlightblue,
      bottom color=uniSblue,
      shading angle=-45]
      (current page.north west) rectangle (current page.south east);
    \node[%
      circle,
      fill=white,
      anchor=north west,
      minimum size=\circlesize,
      text width=.5\circlesize,
      align=left,
      font=\bfseries\Huge]
      (sectiontitle) at ([xshift=.1\circlesize, yshift=-.2\circlesize]current page.north west) {\insertsection};
    \setlength{\circlesize}{.2\textheight}
    \node[%
      circle,
      fill=uniSgray,
      text=white,
      anchor=center,
      minimum size=\circlesize,
      align=left,
      font=\bfseries\Huge]
      at ([xshift=-.1\circlesize, yshift=-.3\circlesize]sectiontitle.south east) {\thesection};
  \end{tikzpicture}
}


\setbeamertemplate{section in toc}{%
  \usebeamercolor[bg]{item projected}%
  \begin{tikzpicture}[node distance=.5em]
    \node[anchor=base, baseline, fill=uniSgray, text=white, circle, inner sep=0pt, minimum size=2em] (no) {\inserttocsectionnumber};
    \node[right=of no] {\color{uniSblue} \inserttocsection};
  \end{tikzpicture}
}

\setbeamertemplate{frametitle}%
{
  \nointerlineskip
  \begin{beamercolorbox}[leftskip=2ex, ht=2em,wd=\paperwidth]{frametitle}
    \bfseries\Large\insertframetitle\strut
  \end{beamercolorbox}
}

\setbeamertemplate{itemize/enumerate body begin}{\footnotesize}

\setbeamertemplate{itemize/enumerate subbody begin}{\footnotesize}

\setbeamertemplate{itemize item}{%
  \usebeamercolor[bg]{item projected}%
  \begin{tikzpicture}
    \draw[uniSlightblue,fill=uniSlightblue, opacity=0] (0,0) circle (.1695em);
    \draw[uniSlightblue,fill=uniSlightblue] (.1695em, .1695em) circle (.1695em);
  \end{tikzpicture}
}

\setbeamertemplate{bibliography item}{\insertbiblabel}

\setbeamertemplate{blocks}[rounded][shadow=true]

\defbeamertemplate{note page}{notepageuniS}
{
  \insertvrule{0.45\paperheight}{uniSgray!20}%
  \vskip-0.45\paperheight
  \insertslideintonotes{0.45}

  \noindent\hspace{1em}\begin{minipage}{.9\paperwidth}
    \footnotesize
    \setlist{noitemsep}
    \insertnote
  \end{minipage}
}

\setbeamertemplate{note page}[notepageuniS]

\mode<all>
